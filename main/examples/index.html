
<!DOCTYPE html>


<html lang="en" data-content_root="../" data-theme="light">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Examples &#8212; atlas-ftag-tools v0.2.18 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d75fae25" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=050920a7"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'examples/index';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.1';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://umami-hep.github.io/atlas-ftag-tools/main/_static/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = 'latest';
        DOCUMENTATION_OPTIONS.show_version_warning_banner =
            false;
        </script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Develop" href="../dev_guidelines/index.html" />
    <link rel="prev" title="ATLAS FTAG Python Tools" href="../index.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="light">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">atlas-ftag-tools documentation</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../index.html">
    Quickstart
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="#">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../dev_guidelines/index.html">
    Develop
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../autoapi/index.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://github.com/umami-hep/atlas-ftag-tools/blob/main/changelog.md">
    Changelog
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/umami-hep/atlas-ftag-tools" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../index.html">
    Quickstart
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="#">
    Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../dev_guidelines/index.html">
    Develop
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../autoapi/index.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://github.com/umami-hep/atlas-ftag-tools/blob/main/changelog.md">
    Changelog
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-3"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-3"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-3"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-3">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/umami-hep/atlas-ftag-tools" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github-square fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"></div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Examples</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="examples">
<h1>Examples<a class="headerlink" href="#examples" title="Link to this heading">#</a></h1>
<p>On the following page, examples will be given how the code can be used. The first part
covers scripts and functions that can be used directly from the terminal while the second
part gives a more detailed look on the different functionalities.</p>
<section id="calculate-wps">
<h2>Calculate WPs<a class="headerlink" href="#calculate-wps" title="Link to this heading">#</a></h2>
<p>This package contains a script to calculate tagger working points (WPs).
The script is <code class="docutils literal notranslate"><span class="pre">working_points.py</span></code> and can be run after installing this package with</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wps</span> \
    <span class="o">--</span><span class="n">ttbar</span> <span class="s2">&quot;path/to/ttbar/*.h5&quot;</span> \
    <span class="o">--</span><span class="n">tagger</span> <span class="n">GN2v01</span> \
    <span class="o">--</span><span class="n">fc</span> <span class="mf">0.1</span>
</pre></div>
</div>
<p>Both the <code class="docutils literal notranslate"><span class="pre">--tagger</span></code> and <code class="docutils literal notranslate"><span class="pre">--fc</span></code> options accept a list if you want to get the WPs for multiple taggers.
If you are doing c-tagging or xbb-tagging, dedicated fx arguments are available ()you can find them all with <code class="docutils literal notranslate"><span class="pre">-h</span></code>.</p>
<p>If you want to use the <code class="docutils literal notranslate"><span class="pre">ttbar</span></code> WPs get the efficiencies and rejections for the <code class="docutils literal notranslate"><span class="pre">zprime</span></code> sample, you can add <code class="docutils literal notranslate"><span class="pre">--zprime</span> <span class="pre">&quot;path/to/zprime/*.h5&quot;</span></code> to the command.
Note that a default selection of $p_T &gt; 250 ~GeV$ to jets in the <code class="docutils literal notranslate"><span class="pre">zprime</span></code> sample.</p>
<p>If instead of defining the working points for a series of signal efficiencies, you wish to calculate a WP corresponding to a specific background rejection, the <code class="docutils literal notranslate"><span class="pre">--rejection</span></code> option can be given along with the desired background.</p>
<p>By default the working points are printed to the terminal, but you can save the results to a YAML file with the <code class="docutils literal notranslate"><span class="pre">--outfile</span></code> option.</p>
<p>See <code class="docutils literal notranslate"><span class="pre">wps</span> <span class="pre">--help</span></code> for more options and information.</p>
</section>
<section id="calculate-efficiency-at-discriminant-cut">
<h2>Calculate efficiency at discriminant cut<a class="headerlink" href="#calculate-efficiency-at-discriminant-cut" title="Link to this heading">#</a></h2>
<p>The same script can be used to calculate the efficiency and rejection values at a given discriminant cut value.
The script <code class="docutils literal notranslate"><span class="pre">working_points.py</span></code> can be run after intalling this package as follows</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wps</span> \
    <span class="o">--</span><span class="n">ttbar</span> <span class="s2">&quot;path/to/ttbar/*.h5&quot;</span> \
    <span class="o">--</span><span class="n">tagger</span> <span class="n">GN2v01</span> \
    <span class="o">--</span><span class="n">fx</span> <span class="mf">0.1</span>
    <span class="o">--</span><span class="n">disc_cuts</span> <span class="mf">1.0</span> <span class="mf">1.5</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">--tagger</span></code>, <code class="docutils literal notranslate"><span class="pre">--fx</span></code>, and <code class="docutils literal notranslate"><span class="pre">--outfile</span></code> follow the same procedure as in the ‘Calculate WPs’ script as described above.</p>
</section>
<section id="h5-utils">
<h2>H5 Utils<a class="headerlink" href="#h5-utils" title="Link to this heading">#</a></h2>
<section id="create-virtual-file">
<h3>Create virtual file<a class="headerlink" href="#create-virtual-file" title="Link to this heading">#</a></h3>
<p>This package contains a script to easily merge a set of H5 files.
A virtual file is a fast and lightweight way to wrap a set of files.
See the <a class="reference external" href="https://docs.h5py.org/en/stable/vds.html">h5py documentation</a> for more information on virtual datasets.</p>
<p>The script is <code class="docutils literal notranslate"><span class="pre">vds.py</span></code> and can be run after installing this package with</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vds</span> <span class="o">&lt;</span><span class="n">pattern</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">output</span> <span class="n">path</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">&lt;pattern&gt;</span></code> argument should be a quotes enclosed <a class="reference external" href="https://en.wikipedia.org/wiki/Glob_(programming)">glob pattern</a>, for example <code class="docutils literal notranslate"><span class="pre">&quot;dsid/path/*.h5&quot;</span></code></p>
<p>If you don’t want to glob an entire path, or if you want to merge files that do not contain a common string, you can instead use the regex option as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vds</span> <span class="o">&lt;</span><span class="n">regex_pattern</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">output</span> <span class="n">path</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">use</span><span class="o">-</span><span class="n">regex</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">&lt;regex_pattern&gt;</span></code> can contain a list of files, for example <code class="docutils literal notranslate"><span class="pre">&quot;dsid/path/(myfile_id1|myfile_id5|other_file).h5&quot;</span></code>.
You can also regex match files located in a different folder, specifying the option <code class="docutils literal notranslate"><span class="pre">--regex_path</span></code>.</p>
<p>See <code class="docutils literal notranslate"><span class="pre">vds</span> <span class="pre">--help</span></code> for more options and information.</p>
</section>
<section id="h5move">
<h3><a class="reference internal" href="#ftag/hdf5/h5move.py"><span class="xref myst">h5move</span></a><a class="headerlink" href="#h5move" title="Link to this heading">#</a></h3>
<p>A script to move/rename datasets inside an h5file.
Useful for correcting discrepancies between group names.
See <a class="reference internal" href="#ftag/hdf5/h5move.py"><span class="xref myst">h5move.py</span></a> for more info.</p>
</section>
<section id="h5split">
<h3><a class="reference internal" href="#ftag/hdf5/h5split.py"><span class="xref myst">h5split</span></a><a class="headerlink" href="#h5split" title="Link to this heading">#</a></h3>
<p>A script to split a large h5 file into several smaller files.
Useful if output files are too large for EOS/grid storage.
See <a class="reference internal" href="#ftag/hdf5/h5split.py"><span class="xref myst">h5split.py</span></a> for more info.</p>
</section>
</section>
<section id="extensive-examples">
<h2>Extensive Examples<a class="headerlink" href="#extensive-examples" title="Link to this heading">#</a></h2>
<p>The content below is generated automatically from <code class="docutils literal notranslate"><span class="pre">ftag/example.ipynb</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="o">%</span><span class="n">load_ext</span> <span class="n">autoreload</span>
<span class="o">%</span><span class="n">autoreload</span> <span class="mi">2</span>
</pre></div>
</div>
</section>
</section>
<section id="example-usage">
<h1>Example Usage<a class="headerlink" href="#example-usage" title="Link to this heading">#</a></h1>
<p>This notebooks demonstrates how to use this package.
The main features are:</p>
<ul class="simple">
<li><p>A <code class="docutils literal notranslate"><span class="pre">Cuts</span></code> class that can be used to select jets.</p></li>
<li><p>A set of <code class="docutils literal notranslate"><span class="pre">Flavours</span></code> defining common jet flavours.</p></li>
<li><p>An <code class="docutils literal notranslate"><span class="pre">H5Reader</span></code> class allowing for batched reading of jets across multiple files.</p></li>
<li><p>An <code class="docutils literal notranslate"><span class="pre">H5Writer</span></code> class allowing for batched writing of jets.</p></li>
</ul>
<p>We can start by getting some dummy data to work with.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ftag</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_mock_file</span>

<span class="n">fname</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">get_mock_file</span><span class="p">()</span>
<span class="n">jets</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;jets&quot;</span><span class="p">]</span>
</pre></div>
</div>
<section id="cuts">
<h2>Cuts<a class="headerlink" href="#cuts" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">Cuts</span></code> class provides an interface for applying selections to structured nummpy arrays loaded from HDF5 files.
To take a look, first import the <code class="docutils literal notranslate"><span class="pre">Cuts</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ftag</span><span class="w"> </span><span class="kn">import</span> <span class="n">Cuts</span>
</pre></div>
</div>
<p>Instances of <code class="docutils literal notranslate"><span class="pre">Cuts</span></code> can be defined from lists of strings or tuples of strings and values. For example</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">kinematic_cuts</span> <span class="o">=</span> <span class="n">Cuts</span><span class="o">.</span><span class="n">from_list</span><span class="p">([</span><span class="s2">&quot;pt &gt; 20e3&quot;</span><span class="p">,</span> <span class="s2">&quot;abs_eta &lt; 2.5&quot;</span><span class="p">])</span>
<span class="n">flavour_cuts</span> <span class="o">=</span> <span class="n">Cuts</span><span class="o">.</span><span class="n">from_list</span><span class="p">([(</span><span class="s2">&quot;HadronConeExclTruthLabelID&quot;</span><span class="p">,</span> <span class="s2">&quot;==&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)])</span>
</pre></div>
</div>
<p>It’s easy to combine cuts</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">combined_cuts</span> <span class="o">=</span> <span class="n">kinematic_cuts</span> <span class="o">+</span> <span class="n">flavour_cuts</span>
</pre></div>
</div>
<p>And then apply them to a a structured array with</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">idx</span><span class="p">,</span> <span class="n">selected_jets</span> <span class="o">=</span> <span class="n">combined_cuts</span><span class="p">(</span><span class="n">jets</span><span class="p">)</span>
</pre></div>
</div>
<p>Both the selected indices and the selected jets are returned. The indices can be used to reapply the same selection to another array (e.g. tracks). The return values <code class="docutils literal notranslate"><span class="pre">idx</span></code> and <code class="docutils literal notranslate"><span class="pre">values</span></code> can also be accessed by name:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">idx</span> <span class="o">=</span> <span class="n">combined_cuts</span><span class="p">(</span><span class="n">jets</span><span class="p">)</span><span class="o">.</span><span class="n">idx</span>
<span class="n">selected_jets</span> <span class="o">=</span> <span class="n">combined_cuts</span><span class="p">(</span><span class="n">jets</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</section>
<section id="flavours">
<h2>Flavours<a class="headerlink" href="#flavours" title="Link to this heading">#</a></h2>
<p>A list of flavours is provided.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ftag</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flavours</span>

<span class="n">Flavours</span><span class="o">.</span><span class="n">bjets</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Label(name=&#39;bjets&#39;, label=&#39;$b$-jets&#39;, cuts=[&#39;HadronConeExclTruthLabelID == 5&#39;], colour=&#39;tab:blue&#39;, category=&#39;single-btag&#39;, _px=None)
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">dict</span></code> like access is also supported:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Flavours</span><span class="p">[</span><span class="s2">&quot;qcd&quot;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Label(name=&#39;qcd&#39;, label=&#39;QCD&#39;, cuts=[&#39;R10TruthLabel_R22v1 == 10&#39;], colour=&#39;#38761D&#39;, category=&#39;xbb&#39;, _px=None)
</pre></div>
</div>
<p>As you can see from the output, each flavour has a <code class="docutils literal notranslate"><span class="pre">name</span></code>, a <code class="docutils literal notranslate"><span class="pre">label</span></code> and <code class="docutils literal notranslate"><span class="pre">colour</span></code> (used for plotting), and a <code class="docutils literal notranslate"><span class="pre">Cuts</span></code> instance, which can be used to select jets of the given flavour.
For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">bjets</span> <span class="o">=</span> <span class="n">Flavours</span><span class="o">.</span><span class="n">bjets</span><span class="o">.</span><span class="n">cuts</span><span class="p">(</span><span class="n">jets</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
<p>Each flavour is also assigned to a category, which can be used to group flavours together. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Flavours</span><span class="o">.</span><span class="n">categories</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[&#39;single-btag&#39;,
 &#39;single-btag-extended&#39;,
 &#39;single-btag-ghost&#39;,
 &#39;xbb&#39;,
 &#39;xbb-extended&#39;,
 &#39;partonic&#39;,
 &#39;lepton-decay&#39;,
 &#39;PDGID&#39;,
 &#39;isolation&#39;,
 &#39;trigger-xbb&#39;]
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Flavours</span><span class="o">.</span><span class="n">by_category</span><span class="p">(</span><span class="s2">&quot;xbb&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>LabelContainer(hbb, hcc, top, qcd, qcdbb, qcdnonbb, qcdbx, qcdcx, qcdll, htauel, htaumu, htauhad)
</pre></div>
</div>
<p>Probability names are also accessible using <code class="docutils literal notranslate"><span class="pre">.px</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">px</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">Flavours</span><span class="o">.</span><span class="n">by_category</span><span class="p">(</span><span class="s2">&quot;single-btag&quot;</span><span class="p">)]</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[&#39;pb&#39;, &#39;pc&#39;, &#39;pu&#39;, &#39;ptau&#39;]
</pre></div>
</div>
<p>And you can also access a flavour from it’s definition</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Flavours</span><span class="o">.</span><span class="n">from_cuts</span><span class="p">([</span><span class="s2">&quot;HadronConeExclTruthLabelID == 5&quot;</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Label(name=&#39;bjets&#39;, label=&#39;$b$-jets&#39;, cuts=[&#39;HadronConeExclTruthLabelID == 5&#39;], colour=&#39;tab:blue&#39;, category=&#39;single-btag&#39;, _px=None)
</pre></div>
</div>
</section>
<section id="h5reader">
<h2>H5Reader<a class="headerlink" href="#h5reader" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">H5Reader</span></code> class allows you to read (batches) of jets from one or more HDF5 files.</p>
<ul class="simple">
<li><p>Variables are specified as <code class="docutils literal notranslate"><span class="pre">dict[str,</span> <span class="pre">list[str]]</span></code>.</p></li>
<li><p>By default the reader will randomly access chunks in the file, giving you a weakly shuffled set of jets.</p></li>
<li><p>By default the reader will load all variables for all available jets if <code class="docutils literal notranslate"><span class="pre">variables</span></code> and <code class="docutils literal notranslate"><span class="pre">num_jets</span></code> are not specified respectively.</p></li>
</ul>
<p>For example to load 300 jets using three batches of size 100:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ftag.hdf5</span><span class="w"> </span><span class="kn">import</span> <span class="n">H5Reader</span>

<span class="n">reader</span> <span class="o">=</span> <span class="n">H5Reader</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">load</span><span class="p">({</span><span class="s2">&quot;jets&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="s2">&quot;eta&quot;</span><span class="p">]},</span> <span class="n">num_jets</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;jets&quot;</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>300
</pre></div>
</div>
<p>To transparently load jets across several files <code class="docutils literal notranslate"><span class="pre">fname</span></code> can also be a pattern including wildcards (<code class="docutils literal notranslate"><span class="pre">*</span></code>).
Behind the scenes files are globbed and merged into a <a class="reference external" href="https://docs.h5py.org/en/stable/vds.html">virtual dataset</a>.
So the following also works:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="n">reader</span> <span class="o">=</span> <span class="n">H5Reader</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;*.h5&quot;</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
<p>If you have globbed several files, you can easily get the total number of jets across all files with</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">reader</span><span class="o">.</span><span class="n">num_jets</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>1000
</pre></div>
</div>
<p>You can also load tracks alongside jets (or by themselves) by specifying an additional entry in the <code class="docutils literal notranslate"><span class="pre">variables</span></code> dict:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">load</span><span class="p">({</span><span class="s2">&quot;jets&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="s2">&quot;eta&quot;</span><span class="p">],</span> <span class="s2">&quot;tracks&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;deta&quot;</span><span class="p">,</span> <span class="s2">&quot;dphi&quot;</span><span class="p">]},</span> <span class="n">num_jets</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;tracks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dtype([(&#39;dphi&#39;, &#39;&lt;f4&#39;), (&#39;deta&#39;, &#39;&lt;f4&#39;)])
</pre></div>
</div>
<p>You can apply cuts to the jets as they are loaded. For example, to load 1000 jets which satisfy $p_T &gt; 20$ GeV:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">load</span><span class="p">({</span><span class="s2">&quot;jets&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pt&quot;</span><span class="p">]},</span> <span class="n">num_jets</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">cuts</span><span class="o">=</span><span class="n">Cuts</span><span class="o">.</span><span class="n">from_list</span><span class="p">([</span><span class="s2">&quot;pt &gt; 20e3&quot;</span><span class="p">]))</span>
<span class="k">assert</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;jets&quot;</span><span class="p">][</span><span class="s2">&quot;pt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">20e3</span>
</pre></div>
</div>
<p>Rather than return a single <code class="docutils literal notranslate"><span class="pre">dict</span></code> of arrays, the reader can also return a generator of batches.
This is useful when you want to work with a large number of jets, but don’t want to load them all into memory at once.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">reader</span> <span class="o">=</span> <span class="n">H5Reader</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">stream</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">stream</span><span class="p">({</span><span class="s2">&quot;jets&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="s2">&quot;eta&quot;</span><span class="p">]},</span> <span class="n">num_jets</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
    <span class="n">jets</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;jets&quot;</span><span class="p">]</span>
    <span class="c1"># do processing on batch...</span>
</pre></div>
</div>
</section>
<section id="h5writer">
<h2>H5Writer<a class="headerlink" href="#h5writer" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">H5Writer</span></code> class complents the reader class by allowing you to easily write batches of jets to a target file.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">tempfile</span><span class="w"> </span><span class="kn">import</span> <span class="n">NamedTemporaryFile</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">ftag.hdf5</span><span class="w"> </span><span class="kn">import</span> <span class="n">H5Writer</span>

<span class="n">reader</span> <span class="o">=</span> <span class="n">H5Reader</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">variables</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;jets&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>  <span class="c1"># &quot;None&quot; means &quot;all variables&quot;</span>
<span class="n">out_fname</span> <span class="o">=</span> <span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.h5&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">H5Writer</span><span class="p">(</span>
    <span class="n">dst</span><span class="o">=</span><span class="n">out_fname</span><span class="p">,</span>
    <span class="n">dtypes</span><span class="o">=</span><span class="n">reader</span><span class="o">.</span><span class="n">dtypes</span><span class="p">(</span><span class="n">variables</span><span class="p">),</span>
    <span class="n">shapes</span><span class="o">=</span><span class="n">reader</span><span class="o">.</span><span class="n">shapes</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>To write jets in batches to the output file, you can use the <code class="docutils literal notranslate"><span class="pre">write</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">reader</span><span class="o">.</span><span class="n">stream</span><span class="p">(</span><span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span> <span class="n">num_jets</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>When you are finished you need to manually close the file using <code class="docutils literal notranslate"><span class="pre">H5Writer.close()</span></code>.
The two files will now have the same contents (since we disabled shuffling):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>

<span class="k">assert</span> <span class="p">(</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fname</span><span class="p">)[</span><span class="s2">&quot;jets&quot;</span><span class="p">][:]</span> <span class="o">==</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">out_fname</span><span class="p">)[</span><span class="s2">&quot;jets&quot;</span><span class="p">][:])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="data-transform">
<h2>Data Transform<a class="headerlink" href="#data-transform" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">transform.py</span></code> module allows for data to be transformed as it is loaded.
Three operations are supported:</p>
<ul class="simple">
<li><p>Renaming variables</p></li>
<li><p>Mapping integer values</p></li>
<li><p>Functional transforms on floating point values</p></li>
</ul>
<p>See below for an example. First, we can make a transform config (which in this case just log scales the jet pt).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ftag.transform</span><span class="w"> </span><span class="kn">import</span> <span class="n">Transform</span>

<span class="n">transform_config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;floats_map&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;jets&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;pt&quot;</span><span class="p">:</span> <span class="s2">&quot;log&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="n">transform</span> <span class="o">=</span> <span class="n">Transform</span><span class="p">(</span><span class="o">**</span><span class="n">transform_config</span><span class="p">)</span>
</pre></div>
</div>
<p>This object can be passed to the <code class="docutils literal notranslate"><span class="pre">H5Reader</span></code> constructor.
The resulting object will return transformed values.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">reader</span> <span class="o">=</span> <span class="n">H5Reader</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">load</span><span class="p">({</span><span class="s2">&quot;jets&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span> <span class="s2">&quot;eta&quot;</span><span class="p">]},</span> <span class="n">num_jets</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;jets&quot;</span><span class="p">][</span><span class="s2">&quot;pt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;jets&quot;</span><span class="p">][</span><span class="s2">&quot;pt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(np.float32(8.156475), np.float32(12.896797))
</pre></div>
</div>
</section>
<section id="adding-columns-to-an-h5-file">
<h2>Adding columns to an h5 file.<a class="headerlink" href="#adding-columns-to-an-h5-file" title="Link to this heading">#</a></h2>
<p>Quite often we wish to make minor changes to h5 files, e.g. adding a single new jet or track variable. A helper function, <code class="docutils literal notranslate"><span class="pre">h5_add_column</span></code> is available to aid here.
The function requires an input file, and output file, and a function (or list of functions) which return a dictionary detailing what needs to be appended. An example is included below</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">ftag.hdf5</span><span class="w"> </span><span class="kn">import</span> <span class="n">h5_add_column</span>


<span class="k">def</span><span class="w"> </span><span class="nf">add_number_of_tracks</span><span class="p">(</span><span class="n">batch</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add the number of tracks to the jets dict.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    batch : dict</span>
<span class="sd">        Loaded batch of jets</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        dict with the number of tracks in the jets dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_tracks</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;tracks&quot;</span><span class="p">][</span><span class="s2">&quot;valid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;jets&quot;</span><span class="p">:</span> <span class="p">{</span>  <span class="c1"># Add to the &#39;jets&#39; group</span>
            <span class="s2">&quot;number_of_tracks&quot;</span><span class="p">:</span> <span class="n">num_tracks</span><span class="p">,</span>  <span class="c1"># ... a new variable called &#39;number_of_tracks&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>


<span class="n">dummy_file</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="c1"># Should be False</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Input has &#39;number_of_tracks&#39;? &quot;</span><span class="p">,</span> <span class="s2">&quot;number_of_tracks&quot;</span> <span class="ow">in</span> <span class="n">dummy_file</span><span class="p">[</span><span class="s2">&quot;jets&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>

<span class="c1"># Create a temporary file path for output</span>
<span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdir</span><span class="p">:</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;output.h5&quot;</span>
    <span class="n">h5_add_column</span><span class="p">(</span>
        <span class="n">fname</span><span class="p">,</span>
        <span class="n">output</span><span class="p">,</span>
        <span class="n">add_number_of_tracks</span><span class="p">,</span>
        <span class="n">num_jets</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Check if the new column was added</span>
    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="c1"># Should be True</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Output has &#39;number_of_tracks&#39;? &quot;</span><span class="p">,</span> <span class="s2">&quot;number_of_tracks&quot;</span> <span class="ow">in</span> <span class="n">dummy_file</span><span class="p">[</span><span class="s2">&quot;jets&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span>
        <span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Input has &#39;number_of_tracks&#39;?  False
Output has &#39;number_of_tracks&#39;?  False
</pre></div>
</div>
<p>You ccan also use the above as a script from the terminal</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>h5addcol<span class="w"> </span>--input<span class="w"> </span><span class="o">[</span>input<span class="w"> </span>file<span class="o">]</span><span class="w"> </span>--append_function<span class="w"> </span>/a/path/to/a/python/script.py:a_function1<span class="w"> </span>/a/differentpath/to/a/python/script.py:a_function2
</pre></div>
</div>
<p>Which will then <code class="docutils literal notranslate"><span class="pre">a_function1</span></code> from <code class="docutils literal notranslate"><span class="pre">/a/path/to/a/python/script.py</span></code> and  <code class="docutils literal notranslate"><span class="pre">a_function2</span></code> from <code class="docutils literal notranslate"><span class="pre">/a/differentpath/to/a/python/script.py</span></code></p>
</section>
<section id="optimization-of-fraction-values">
<h2>Optimization of Fraction Values<a class="headerlink" href="#optimization-of-fraction-values" title="Link to this heading">#</a></h2>
<p>In flavour tagging, we don’t use the output probabilities of our networks directly. To make them easier to use, the multi-dimensional output is broken down into a one dimensional flavour tagging discriminant, $D_b$. The index marks for which type of tagging the discriminant will be used. In the example here, we will discuss this for $b$-tagging. The full $b$-tagging discriminant for “single-btag”, meaning four classes in total ($b$, $c$, light, $\tau$), is defined as:</p>
<p>$$ D_b = \ln \left(\frac{p_b}{f_c \cdot p_c + f_\text{light} \cdot p_u + f_\tau \cdot p_\tau} \right) \qquad \text{with } 1 = f_c + f_\text{light} + f_\tau $$</p>
<p>While in the case of three total classes (one signal, two background) the optimization can still be done using 2D plots and “try and error”, the optimization for four or more total classes suffers under the high dimensionality of the problem. To counteract this and still be able to optimize the fraction values, the <code class="docutils literal notranslate"><span class="pre">atlas-ftag-tools</span></code> provide a callable script/function called <code class="docutils literal notranslate"><span class="pre">fraction_optimization</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">fraction_optimization</span></code> uses the jets provided to find the optimal fraction values using a minimization technique. The following steps are run during this optimization:</p>
<ul class="simple">
<li><p>For the given tagger/WP, calculate the maximally reachable rejection per flavour as a normalization for the final optimization.</p></li>
<li><p>Calculate the sum of all rejections in a normalized way using the previously extracted maximally reachable rejection per flavour.</p></li>
<li><p>To be able to optimize this, the total normalized sum of all rejections is multiplied by -1. This new function is given to a minimizer, which optimizes the fraction values based on the negative normalized sum of all rejections.</p></li>
<li><p>The optimizer returns now a dict with the optimal fraction values.</p></li>
<li><p>To manually balance each class against each other, one can introduce <code class="docutils literal notranslate"><span class="pre">rejection_weights</span></code>, with which you can balance and fine tune a bit the optimization process.</p></li>
</ul>
<section id="terminal-usage">
<h3>Terminal Usage<a class="headerlink" href="#terminal-usage" title="Link to this heading">#</a></h3>
<p>To use the script directly from your terminal, you can run the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>fraction_optimization<span class="w"> </span>-i<span class="w"> </span>&lt;path-to-h5&gt;<span class="w"> </span>-t<span class="w"> </span>&lt;tagger-name&gt;<span class="w"> </span>-s<span class="w"> </span>&lt;signal-flavour&gt;<span class="w"> </span>-w<span class="w"> </span>&lt;working-point&gt;
</pre></div>
</div>
<p>This will calculate the optimal fraction values and will print it to your terminal. Please make sure to run</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>fraction_optimization<span class="w"> </span>-h
</pre></div>
</div>
<p>once to check which other options are available and which defaults are set for them.</p>
</section>
<section id="usage-in-a-python-script">
<h3>Usage in a Python Script<a class="headerlink" href="#usage-in-a-python-script" title="Link to this heading">#</a></h3>
<p>In addition to the functionality as a callable script, you can also import the function to optimize your fraction values directly to your own script. In the example here, we assume that you loaded all the jets and their variables as data and the jet variables are in the key <code class="docutils literal notranslate"><span class="pre">jets</span></code>. The example will use the <code class="docutils literal notranslate"><span class="pre">MockTagger</span></code> tagger and will use the default <code class="docutils literal notranslate"><span class="pre">single-btag</span></code> flavours with <code class="docutils literal notranslate"><span class="pre">bjets</span></code> as signal. As working point, we will use the 70% working point.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ftag.fraction_optimization</span><span class="w"> </span><span class="kn">import</span> <span class="n">calculate_best_fraction_values</span>

<span class="c1"># Get a test file and load the jets from it</span>
<span class="n">_</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">get_mock_file</span><span class="p">()</span>
<span class="n">jets</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;jets&quot;</span><span class="p">]</span>

<span class="c1"># Get the optimal fraction dict</span>
<span class="n">optimal_fraction_dict</span> <span class="o">=</span> <span class="n">calculate_best_fraction_values</span><span class="p">(</span>
    <span class="n">jets</span><span class="o">=</span><span class="n">jets</span><span class="p">,</span>
    <span class="n">tagger</span><span class="o">=</span><span class="s2">&quot;MockTagger&quot;</span><span class="p">,</span>
    <span class="n">signal</span><span class="o">=</span><span class="n">Flavours</span><span class="p">[</span><span class="s2">&quot;bjets&quot;</span><span class="p">],</span>
    <span class="n">flavours</span><span class="o">=</span><span class="n">Flavours</span><span class="o">.</span><span class="n">by_category</span><span class="p">(</span><span class="s2">&quot;single-btag&quot;</span><span class="p">),</span>
    <span class="n">working_point</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
    <span class="n">rejection_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">optimizer_method</span><span class="o">=</span><span class="s2">&quot;Powell&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>In this example, we wrote out all possible options.</p>
<p>The code will return a dict with the optimal fraction values, that you can then directly use in your code.</p>
</section>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../index.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">ATLAS FTAG Python Tools</p>
      </div>
    </a>
    <a class="right-next"
       href="../dev_guidelines/index.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Develop</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Examples</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-wps">Calculate WPs</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calculate-efficiency-at-discriminant-cut">Calculate efficiency at discriminant cut</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#h5-utils">H5 Utils</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#create-virtual-file">Create virtual file</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#h5move"><span class="xref myst">h5move</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#h5split"><span class="xref myst">h5split</span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extensive-examples">Extensive Examples</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#example-usage">Example Usage</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cuts">Cuts</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#flavours">Flavours</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#h5reader">H5Reader</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#h5writer">H5Writer</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-transform">Data Transform</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-columns-to-an-h5-file">Adding columns to an h5 file.</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#optimization-of-fraction-values">Optimization of Fraction Values</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#terminal-usage">Terminal Usage</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#usage-in-a-python-script">Usage in a Python Script</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </nav></div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/examples/index.md.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>